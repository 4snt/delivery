generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // Pooled connection for queries
  // Usando a mesma URL para migrations (defina POSTGRES_URL_NON_POOLING se preferir, mas não é obrigatório).
  directUrl = env("POSTGRES_PRISMA_URL")
}

model Adicional {
  id        BigInt              @id @default(autoincrement())
  nome      String
  pedidos   PedidoAdicional[]
  favoritos FavoritoAdicional[]
}

model Sabor {
  id        BigInt          @id @default(autoincrement())
  nome      String
  imagem    String
  pedidos   PedidoSabor[]
  favoritos FavoritoSabor[]
}

model Cliente {
  id               BigInt               @id @default(autoincrement())
  email            String               @unique
  nome             String
  senha            String
  isAdmin          Boolean              @default(false)
  pontosFidelidade Int                  @default(0)
  pedidos          Pedido[]
  favoritos        Favorito[]
  transacoes       FidelidadeTransacao[]
}

model Pedido {
  id              BigInt          @id @default(autoincrement())
  cliente         Cliente         @relation(fields: [clienteId], references: [id])
  clienteId       BigInt
  sabores         PedidoSabor[]
  adicionais      PedidoAdicional[]
  tamanho         String
  valorTotal      Float
  formaPagamento  String
  enderecoEntrega String
  status          String          @default("Pendente")
  cupomCodigo     String?
  descontoAplicado Float          @default(0)
  createdAt       DateTime        @default(now())
}

model PedidoSabor {
  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  pedidoId BigInt
  sabor    Sabor  @relation(fields: [saborId], references: [id], onDelete: Cascade)
  saborId  BigInt

  @@id([pedidoId, saborId])
}

model PedidoAdicional {
  pedido      Pedido    @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  pedidoId    BigInt
  adicional   Adicional @relation(fields: [adicionalId], references: [id], onDelete: Cascade)
  adicionalId BigInt

  @@id([pedidoId, adicionalId])
}

model Cupom {
  id          BigInt   @id @default(autoincrement())
  codigo      String   @unique
  descricao   String?
  tipo        String   // percentual ou valor_fixo
  valor       Float
  valorMinimo Float    @default(0)
  usoMaximo   Int?
  usosAtuais  Int      @default(0)
  ativo       Boolean  @default(true)
  expiraEm    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Favorito {
  id          BigInt            @id @default(autoincrement())
  cliente     Cliente           @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  clienteId   BigInt
  nome        String
  tamanho     String
  preco       Float
  sabores     FavoritoSabor[]
  adicionais  FavoritoAdicional[]
  createdAt   DateTime          @default(now())
}

model FavoritoSabor {
  favorito   Favorito @relation(fields: [favoritoId], references: [id], onDelete: Cascade)
  favoritoId BigInt
  sabor      Sabor    @relation(fields: [saborId], references: [id], onDelete: Cascade)
  saborId    BigInt

  @@id([favoritoId, saborId])
}

model FavoritoAdicional {
  favorito     Favorito   @relation(fields: [favoritoId], references: [id], onDelete: Cascade)
  favoritoId   BigInt
  adicional    Adicional  @relation(fields: [adicionalId], references: [id], onDelete: Cascade)
  adicionalId  BigInt

  @@id([favoritoId, adicionalId])
}

model FidelidadeTransacao {
  id        BigInt   @id @default(autoincrement())
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  clienteId BigInt
  tipo      String   // earn | redeem
  pontos    Int
  descricao String?
  createdAt DateTime @default(now())
}
